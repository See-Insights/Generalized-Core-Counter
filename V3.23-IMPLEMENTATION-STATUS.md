# V3.23 Architecture Refactor - Implementation Status

## COMPLETED CHANGES

### 1. MyPersistentData.h & .cpp ✅
- **Renamed CountingMode → SensorMode** (COUNTING, OCCUPANCY, MEASUREMENT)
- **Renamed OperatingMode → ConnectionMode** (CONNECTED, INTERMITTENT, DISCONNECTED, INTERMITTENT_KEEP_ALIVE)
- **Added ReportingMode** enum (SCHEDULED, ON_CHANGE, THRESHOLD, SCHEDULED_OR_THRESHOLD)
- **Added SamplingMode** enum (INTERRUPT, POLLING)
- **Removed** occupancyDebounceMs from SysData (now sensor.setting1)
- **Added** verboseTimeoutMin and verboseModeStartTime to SysData
- **Replaced** sensor threshold1/threshold2/pollingRate with generic type + setting1-4
- **Updated** all getter/setter functions
- **Updated** initialize() defaults

### 2. Cloud.cpp & Cloud.h ✅
- **Removed** applyPowerConfig() function (power section eliminated)
- **Updated** applySensorConfig() for generic sensor.type + setting1-4
- **Updated** applyTimingConfig() to parse connectAttemptBudgetSec
- **Updated** applyMessagingConfig() to parse verboseTimeoutMin
- **Updated** applyModesConfig() for all 4 new modes (sensorMode, connectionMode, reportingMode, samplingMode)
- **Updated** writeDeviceStatusToCloud() to publish new v3.23 structure
- **Updated** publishDataToLedger() to use sensorMode instead of countingMode
- **Updated** hasNonDefaultConfig() for new sensor fields

### 3. Version.cpp ✅
- **Bumped** to "3.23"
- **Updated** release notes

### 4. Configuration Files ✅
- **Created** default-settings-v3.23.json with new structure

## REMAINING CHANGES REQUIRED (Manual)

### 5. State Machine Files (HIGH PRIORITY)
Need to update all references from old to new enum names:

**State_Idle.cpp:**
- Line 54: `sysStatus.get_operatingMode()` → `sysStatus.get_connectionMode()`
- Line 67: `sysStatus.get_countingMode()` → `sysStatus.get_sensorMode()`
- Line 122: `sysStatus.get_operatingMode()` → `sysStatus.get_connectionMode()`
- Line 141: `sysStatus.get_operatingMode()` → `sysStatus.get_connectionMode()`
- Comments: `LOW_POWER` → `INTERMITTENT`

**State_Sleep.cpp:**
- Line 50: `sysStatus.get_operatingMode() == CONNECTED` → `sysStatus.get_connectionMode() == CONNECTED`
- Line 188: Same update
- Line 336: `sysStatus.get_operatingMode() == DISCONNECTED_KEEP_ALIVE` → `sysStatus.get_connectionMode() == INTERMITTENT_KEEP_ALIVE`
- Line 459: Same update
- Line 472: `sysStatus.get_countingMode() == COUNTING` → `sysStatus.get_sensorMode() == COUNTING`
- Line 478: `sysStatus.get_countingMode() == OCCUPANCY` → `sysStatus.get_sensorMode() == OCCUPANCY`
- Line 526: `sysStatus.get_operatingMode() != CONNECTED` → `sysStatus.get_connectionMode() != CONNECTED`
- Comments: Replace `LOW_POWER` → `INTERMITTENT`, `DISCONNECTED_KEEP_ALIVE` → `INTERMITTENT_KEEP_ALIVE`

**State_Modes.cpp:**
- Line 72: `sysStatus.get_operatingMode() == DISCONNECTED_KEEP_ALIVE` → `sysStatus.get_connectionMode() == INTERMITTENT_KEEP_ALIVE`
- Line 127: Same update
- Comments: Update mode references

**State_Report.cpp:**
- Line 60: `sysStatus.get_countingMode() == COUNTING` → `sysStatus.get_sensorMode() == COUNTING`

**State_Error.cpp:**
- Line 112: `sysStatus.get_operatingMode() != CONNECTED` → `sysStatus.get_connectionMode() != CONNECTED`
- Comments: `LOW_POWER` → `INTERMITTENT`

### 6. Generalized-Core-Counter.cpp (HIGH PRIORITY)
- Line 122: Comment update `LOW_POWER` → `INTERMITTENT`
- Lines 330-333: operatingMode logging → connectionMode, update mode names
- Line 434: `sysStatus.get_countingMode()` → `sysStatus.get_sensorMode()`
- Line 555: Same update
- Lines 778, 795, 799: Comment updates `LOW_POWER` → `INTERMITTENT`

**ADD VERBOSE MODE IMPLEMENTATION:**
After line ~195 (after sensorConfig.setup()):
```cpp
  // Apply serial log level based on serial flag
  if (sysStatus.get_serialConnected()) {
    Serial.begin(9600);
    Log.level(LOG_LEVEL_INFO);
    Log.info("Serial logging enabled (LOG_LEVEL_INFO)");
  } else {
    Log.level(LOG_LEVEL_ERROR);
  }
```

**ADD VERBOSE MODE HELPER FUNCTIONS:**
After includes section (~line 80):
```cpp
// Verbose mode tracking
unsigned long lastVerbosePublish = 0;
const unsigned long VERBOSE_MIN_INTERVAL = 1000; // 1 event/second

/**
 * @brief Publish verbose diagnostic event to Particle cloud
 * @param category Event category (state, connect, sensor, error, power)
 * @param message Diagnostic message
 */
void publishVerbose(const char* category, const char* message) {
    if (!sysStatus.get_verboseMode()) return;
    if (millis() - lastVerbosePublish < VERBOSE_MIN_INTERVAL) return;
    
    char eventName[32];
    snprintf(eventName, sizeof(eventName), "v/%s", category);
    Particle.publish(eventName, message, PRIVATE);
    lastVerbosePublish = millis();
    
    // Check verbose mode timeout
    if (sysStatus.get_verboseModeStartTime() > 0 && sysStatus.get_verboseTimeoutMin() > 0) {
        unsigned long elapsedMin = (Time.now() - sysStatus.get_verboseModeStartTime()) / 60;
        if (elapsedMin >= sysStatus.get_verboseTimeoutMin()) {
            sysStatus.set_verboseMode(false);
            sysStatus.set_verboseModeStartTime(0);
            Particle.publish("v/system", "Verbose timeout - auto-disabled", PRIVATE);
            Log.info("Verbose mode auto-disabled after %lu minutes", elapsedMin);
        }
    }
}
```

**ADD VERBOSE PUBLISH CALLS (Strategic Locations):**
- State transitions: `publishVerbose("state", "Entering CONNECTING_STATE");`
- Connection results: `publishVerbose("connect", "Connected in 15s");`
- Sensor triggers: `publishVerbose("sensor", "PIR trigger detected");`
- Errors: `publishVerbose("error", "Connection timeout");`

### 7. PIRSensor.cpp (MEDIUM PRIORITY)
Update to use sensor.setting1 instead of occupancyDebounceMs:
```cpp
uint32_t debounceMs = sensorConfig.get_sensorSetting1();
```

### 8. README.md (HIGH PRIORITY)
Complete rewrite of Configuration Structure section:
- Remove power section documentation
- Update all mode tables with new names and values
- Add sensor type examples (PIR=1, Analog=2, etc.)
- Add verbose mode documentation
- Update all 6+ configuration examples
- Add migration guide from v3.22 → v3.23

### 9. Doxyfile (LOW PRIORITY)
Update PROJECT_NUMBER from "3.22" to "3.23"

### 10. CHANGELOG.md (MEDIUM PRIORITY)
Add v3.23 entry:
```markdown
## [3.23] - 2026-02-05
### Changed
- **BREAKING:** Renamed CountingMode → SensorMode, OperatingMode → ConnectionMode
- **BREAKING:** Renamed LOW_POWER → INTERMITTENT, DISCONNECTED_KEEP_ALIVE → INTERMITTENT_KEEP_ALIVE
- **BREAKING:** Removed power section from configuration
- **BREAKING:** Replaced sensor threshold1/threshold2/pollingRate with generic type + setting1-4
- **BREAKING:** Moved connectAttemptBudgetSec from modes to timing section
- **BREAKING:** Removed occupancyDebounceMs (now sensor.setting1 for PIR sensors)

### Added
- ReportingMode enum (SCHEDULED, ON_CHANGE, THRESHOLD, SCHEDULED_OR_THRESHOLD)
- SamplingMode enum (INTERRUPT, POLLING)
- Verbose mode with auto-timeout for remote field diagnostics
- Serial flag controls log level (INFO vs ERROR)
- verboseTimeoutMin configuration parameter

### Improved
- Orthogonal mode architecture: any valid combination of 4 mode dimensions
- Generic sensor configuration supports any sensor type with 4 settings
- Simplified power management (always solar-compatible)
```

## COMPILATION STATUS

**NOT TESTED YET** - Build system path issue encountered. Once state machine files are updated with enum renames, compilation should succeed.

## MIGRATION NOTES

Devices upgrading from v3.22 → v3.23 will need:
1. **New ledger structure** - default-settings v3.23 must be deployed
2. **Field mapping:**
   - countingMode → sensorMode
   - operatingMode → connectionMode (0=CONNECTED, 1=INTERMITTENT, 2=DISCONNECTED, 3=INTERMITTENT_KEEP_ALIVE)
   - occupancyDebounceMs → sensor.setting1 (for PIR sensors only)
3. **Persistent storage** will auto-initialize with new fields on first boot

## TESTING CHECKLIST

- [ ] Compile successfully
- [ ] Test COUNTING mode (sensorMode=0)
- [ ] Test OCCUPANCY mode (sensorMode=1)
- [ ] Test MEASUREMENT mode (sensorMode=2)
- [ ] Test CONNECTED mode (connectionMode=0)
- [ ] Test INTERMITTENT mode (connectionMode=1)
- [ ] Test INTERMITTENT_KEEP_ALIVE mode (connectionMode=3)
- [ ] Test verbose mode enable/disable
- [ ] Test verbose mode auto-timeout
- [ ] Test serial log level control
- [ ] Verify generic sensor settings work for PIR
- [ ] Verify ledger sync with new structure
- [ ] Verify device-status publishing
- [ ] Verify migration from v3.22

## ESTIMATED COMPLETION TIME

- Remaining code changes: 2-3 hours
- Testing: 2-3 hours
- Documentation: 2-3 hours
- **Total:** 6-9 hours
