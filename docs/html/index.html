<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Generalized-Core-Counter: Generalized-Core-Counter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Generalized-Core-Counter<span id="projectnumber">&#160;3.20</span>
   </div>
   <div id="projectbrief">Particle-based generalized core counter firmware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Generalized-Core-Counter </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a></p>
<p>A generalized IoT firmware core for outdoor sensor devices supporting multiple operating modes and sensor types.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2"></a>
Overview</h1>
<p>This firmware provides a flexible, production-ready platform for outdoor IoT devices (Particle P2 WiFi and Boron Cellular) that can operate in different modes while maintaining a clean, extensible codebase. The architecture uses Particle Ledger for cloud configuration management, enabling offline device configuration updates and real-time data visibility.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md3"></a>
Features</h1>
<ul>
<li><b>Multiple Operating Modes</b>:<ul>
<li><b>Counting Mode</b>: Track individual events (counts per hour/day)</li>
<li><b>Occupancy Mode</b>: Monitor occupied time with debounce logic</li>
</ul>
</li>
<li><b>Power Management</b>:<ul>
<li><b>Connected Mode</b>: Stay connected for real-time updates</li>
<li><b>Low-Power Mode</b>: Sleep between scheduled reports</li>
</ul>
</li>
<li><b>Trigger Types</b>:<ul>
<li><b>Interrupt-Driven</b>: Event-based sensor triggering</li>
<li><b>Scheduled Polling</b>: Periodic sensor checks</li>
</ul>
</li>
<li><b><a class="el" href="class_cloud.html" title="This class is a singleton; you do not create one as a global, on the stack, or with new.">Cloud</a> Configuration</b>:<ul>
<li>Product-level defaults via Ledger</li>
<li>Device-specific overrides (editable offline in Console)</li>
<li>Auto-sync on connection</li>
</ul>
</li>
<li><b>Data Publishing</b>:<ul>
<li>Webhook integration (Ubidots)</li>
<li>Device-to-cloud ledger for Console visibility</li>
<li>Mode-aware JSON payloads</li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md4"></a>
Hardware</h1>
<p>Supported Platforms:</p><ul>
<li><b>Particle P2</b> (WiFi, DeviceOS 6.3.4)</li>
<li><b>Particle Boron</b> (Cellular, DeviceOS 6.3.4)</li>
</ul>
<p>Sensor Support (Extensible):</p><ul>
<li>PIR motion sensor (implemented)</li>
<li>Ultrasonic distance sensor (template)</li>
<li>Custom sensors via <a class="el" href="class_i_sensor.html" title="Abstract interface for all sensors.">ISensor</a> interface</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md5"></a>
Documentation</h1>
<ul>
<li>Bench validation checklist: docs/bench-validation.md</li>
<li>Generated API reference (Doxygen): <b><a href="https://see-insights.github.io/Generalized-Core-Counter/">https://see-insights.github.io/Generalized-Core-Counter/</a></b><ul>
<li>To browse locally: Open <span class="tt">docs/html/index.html</span> in your browser</li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md6"></a>
Architecture</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md7"></a>
Sensor Interface Pattern</h2>
<p>All sensors implement the <span class="tt"><a class="el" href="class_i_sensor.html" title="Abstract interface for all sensors.">ISensor</a></span> interface:</p><ul>
<li><span class="tt"><a class="el" href="_generalized-_core-_counter_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup()</a></span>: Initialize hardware</li>
<li><span class="tt"><a class="el" href="_generalized-_core-_counter_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop()</a></span>: Update sensor state</li>
<li><span class="tt">getSensorData()</span>: Return latest readings</li>
<li><span class="tt">getSensorType()</span>: Identify sensor type</li>
</ul>
<p>New sensors are added via <span class="tt"><a class="el" href="_sensor_factory_8h.html">SensorFactory.h</a></span> without modifying core code.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
State Machine</h2>
<ul>
<li>INITIALIZATION → IDLE → REPORTING → IDLE (connected mode)</li>
<li>INITIALIZATION → IDLE → SLEEPING → IDLE (low-power mode)</li>
<li>ERROR handling with cloud reporting (no reset loops)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
Application State Machine &amp; Handlers</h2>
<p>The main application logic is implemented as a small, explicit state machine:</p>
<ul>
<li><b>Core states</b> (see <a class="el" href="_state_machine_8h.html">src/StateMachine.h</a>): INITIALIZATION, IDLE, CONNECTING, REPORTING, SLEEPING, FIRMWARE_UPDATE, ERROR.</li>
<li><b><a class="el" href="_state_machine_8h.html#a5d74787dedbc4e11c1ab15bf487e61f8">State</a> handlers</b> (see <a class="el" href="_state_handlers_8cpp.html">src/StateHandlers.cpp</a>) encapsulate behaviour for each state (e.g. connection policy, publish cadence, sleep scheduling, and firmware/config update flows).</li>
<li><b><a class="el" href="_state_machine_8h.html#a5d74787dedbc4e11c1ab15bf487e61f8">State</a> driver</b> (see <a class="el" href="_generalized-_core-_counter_8cpp.html">src/Generalized-Core-Counter.cpp</a>) selects the current state in <span class="tt"><a class="el" href="_generalized-_core-_counter_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop()</a></span> and logs transitions via <span class="tt"><a class="el" href="_generalized-_core-_counter_8cpp.html#afb2932b86bac021e349213b370798543">publishStateTransition()</a></span>.</li>
</ul>
<p>This split keeps the outer <span class="tt"><a class="el" href="_generalized-_core-_counter_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup()</a>/loop()</span> structure simple while allowing the per-state behaviour to evolve independently as new modes or error conditions are added.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md10"></a>
Persistent Storage</h2>
<p>Three storage structures:</p><ul>
<li><span class="tt"><a class="el" href="_my_persistent_data_8h.html#a5eda319b411fdadc047a6d8c3aad0241">sysStatus</a></span>: System configuration and state</li>
<li><span class="tt"><a class="el" href="_my_persistent_data_8h.html#a0b7dcc5eefa72dd2fef2a6d42bbb3421">sensorConfig</a></span>: Sensor-specific parameters</li>
<li><span class="tt"><a class="el" href="_my_persistent_data_8h.html#a7ccda8a3a0f47702f9fa962899b0a3a1">current</a></span>: Live data (counts, occupancy, battery, temp)</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
Configuration Management</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
Ledger Architecture</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Ledger  </th><th class="markdownTableHeadNone">Scope  </th><th class="markdownTableHeadNone">Direction  </th><th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Editable?  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">default-settings</span>  </td><td class="markdownTableBodyNone">Product  </td><td class="markdownTableBodyNone">Cloud→Device  </td><td class="markdownTableBodyNone">Product-wide defaults for all devices  </td><td class="markdownTableBodyNone">Yes (Console)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">device-settings</span>  </td><td class="markdownTableBodyNone">Device  </td><td class="markdownTableBodyNone">Cloud→Device  </td><td class="markdownTableBodyNone">Device-specific config overrides  </td><td class="markdownTableBodyNone">Yes (Console, even offline)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">device-status</span>  </td><td class="markdownTableBodyNone">Device  </td><td class="markdownTableBodyNone">Device→Cloud  </td><td class="markdownTableBodyNone">Current device configuration snapshot  </td><td class="markdownTableBodyNone">No (auto-updated by device)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">device-data</span>  </td><td class="markdownTableBodyNone">Device  </td><td class="markdownTableBodyNone">Device→Cloud  </td><td class="markdownTableBodyNone">Latest sensor readings  </td><td class="markdownTableBodyNone">No (auto-updated by device)  </td></tr>
</table>
<p><b>Key Concepts:</b></p><ul>
<li><b>Cloud→Device</b>: You edit in Console, device reads/applies on connection</li>
<li><b>Device→Cloud</b>: Device writes, you view in Console (read-only from Console)</li>
<li><b>device-settings vs device-status</b>: Settings = what you <em>want</em>, Status = what device <em>has</em></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
Configuration Structure</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;messaging&quot;: {</div>
<div class="line">        &quot;disconnectedMode&quot;: false,</div>
<div class="line">        &quot;serial&quot;: false,</div>
<div class="line">        &quot;verboseMode&quot;: false</div>
<div class="line">    },</div>
<div class="line">    &quot;power&quot;: {</div>
<div class="line">        &quot;lowPowerMode&quot;: false,</div>
<div class="line">        &quot;solarPowerMode&quot;: true</div>
<div class="line">    },</div>
<div class="line">    &quot;sensor&quot;: {</div>
<div class="line">        &quot;threshold1&quot;: 60,</div>
<div class="line">        &quot;threshold2&quot;: 60</div>
<div class="line">    },</div>
<div class="line">    &quot;timing&quot;: {</div>
<div class="line">      &quot;closeHour&quot;: 22,</div>
<div class="line">      &quot;openHour&quot;: 6,</div>
<div class="line">      &quot;pollingRateSec&quot;: 0,</div>
<div class="line">      &quot;reportingIntervalSec&quot;: 3600,</div>
<div class="line">      &quot;timezone&quot;: &quot;SGT-8&quot;   </div>
<div class="line">  },</div>
<div class="line">    &quot;modes&quot;: {</div>
<div class="line">        &quot;countingMode&quot;: 0,</div>
<div class="line">        &quot;operatingMode&quot;: 0,</div>
<div class="line">        &quot;triggerMode&quot;: 0,</div>
<div class="line">        &quot;occupancyDebounceMs&quot;: 0,</div>
<div class="line">        &quot;connectedReportingIntervalSec&quot;: 300,</div>
<div class="line">      &quot;lowPowerReportingIntervalSec&quot;: 3600,</div>
<div class="line">      &quot;connectAttemptBudgetSec&quot;: 300</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Timezone notes:</b></p><ul>
<li><span class="tt">timing.timezone</span> must be a POSIX timezone string (not an IANA name like "Asia/Singapore").</li>
<li>Example for Singapore (UTC+8, no DST): <span class="tt">"SGT-8"</span>.</li>
<li>See the LocalTimeRK documentation for examples and guidance on building POSIX strings for major cities: <a href="https://rickkas7.github.io/LocalTimeRK/">https://rickkas7.github.io/LocalTimeRK/</a></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
Mode Values</h2>
<p><b>countingMode</b>:</p><ul>
<li><span class="tt">0</span> = COUNTING (count events)</li>
<li><span class="tt">1</span> = OCCUPANCY (track occupied time)</li>
</ul>
<p><b>operatingMode</b>:</p><ul>
<li><span class="tt">0</span> = CONNECTED (stay connected)</li>
<li><span class="tt">1</span> = LOW_POWER (sleep between reports)</li>
</ul>
<p><b>triggerMode</b>:</p><ul>
<li><span class="tt">0</span> = INTERRUPT (event-driven)</li>
<li><span class="tt">1</span> = SCHEDULED (periodic polling)</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Device Commissioning Workflow</h1>
<ol type="1">
<li><b>Device Flashed</b>: Start with generic Particle firmware</li>
<li><b>Added to Product</b>: Assign to "Generalized-Core-Counter-P2" product</li>
<li><b>Auto-Flashed</b>: Receives product firmware OTA</li>
<li><b>First Connection</b>:<ul>
<li>Syncs <span class="tt">default-settings</span> (product-level defaults)</li>
<li>Checks for <span class="tt">device-settings</span> ledger (Cloud→Device)</li>
<li><b>If no device-settings exists</b> (new device):<ul>
<li>Applies <span class="tt">default-settings</span> to persistent memory</li>
<li><b>Writes <span class="tt">device-status</span> ledger</b> (Device→Cloud) for visibility</li>
<li>Device waits for you to create <span class="tt">device-settings</span> in Console</li>
</ul>
</li>
<li><b>If device-settings exists</b> (configured device):<ul>
<li>Applies <span class="tt">device-settings</span> (overrides defaults)</li>
<li>Updates <span class="tt">device-status</span> to reflect current config</li>
</ul>
</li>
<li>May reset if sensor initialization requires I2C driver changes</li>
</ul>
</li>
<li><b>Data Collection</b>: Starts operating based on configured modes</li>
<li><b>Data Publishing</b>:<ul>
<li>Publishes to webhook (real-time Ubidots integration)</li>
<li>Updates <span class="tt">device-data</span> ledger (Console visibility)</li>
<li>Updates <span class="tt">device-status</span> periodically</li>
</ul>
</li>
<li><b>Configuration Updates</b>:<ul>
<li>On each connection, checks if <span class="tt">device-settings</span> changed</li>
<li>Auto-applies updates if Console values were modified</li>
<li>Logs all configuration changes</li>
<li>Updates <span class="tt">device-status</span> to confirm new config applied</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
Configuration Management Flow</h2>
<p><b>Most Devices (Use Product Defaults):</b></p><ol type="1">
<li>Device connects → Loads <span class="tt">default-settings</span> → Writes <span class="tt">device-status</span></li>
<li>Device operates with product-level configuration</li>
<li>No manual intervention needed</li>
</ol>
<p><b>Devices Needing Custom Config (Different park hours, sensor types, testing mode):</b></p><ol type="1">
<li>Device connects → Loads <span class="tt">default-settings</span> → Writes <span class="tt">device-status</span></li>
<li>In Console, view <span class="tt">device-status</span> ledger (shows current config as JSON)</li>
<li><b>Copy JSON from <span class="tt">device-status</span></b></li>
<li><b>Create new <span class="tt">device-settings</span> ledger</b> for that device (Cloud→Device, Device scope)</li>
<li><b>Paste JSON, modify only the fields you need</b> (e.g., openHour, closeHour, operatingMode)</li>
<li>Save ledger</li>
<li>Device syncs <span class="tt">device-settings</span> on next connection (or trigger connection)</li>
<li><span class="tt">device-status</span> updates to confirm new config</li>
</ol>
<p><b>Example: Park with Different Hours</b></p><ul>
<li><span class="tt">default-settings</span>: <span class="tt">"openHour": 6, "closeHour": 22</span></li>
<li>For specific device, create <span class="tt">device-settings</span>: <div class="fragment"><div class="line">{</div>
<div class="line">  &quot;timing&quot;: {</div>
<div class="line">    &quot;openHour&quot;: 7,</div>
<div class="line">    &quot;closeHour&quot;: 20</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Only override fields that differ, device uses defaults for everything else</li>
</ul>
<p><b>Example: Testing Device (Stay Connected)</b></p><ul>
<li>Create <span class="tt">device-settings</span>: <div class="fragment"><div class="line">{</div>
<div class="line">  &quot;modes&quot;: {</div>
<div class="line">    &quot;operatingMode&quot;: 0</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Device stays in CONNECTED mode instead of LOW_POWER</li>
</ul>
<p><b>Offline Editing:</b></p><ul>
<li>Edit <span class="tt">device-settings</span> in Console anytime (even while device offline)</li>
<li>Device syncs changes on next connection</li>
<li><span class="tt">device-status</span> updates to confirm applied config</li>
<li>Compare <span class="tt">device-settings</span> (desired) vs <span class="tt">device-status</span> (actual) to verify sync</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
Offline Device Management</h1>
<p>You can:</p><ul>
<li>✅ Edit device configuration in Console while device is offline</li>
<li>✅ View last sensor data in <span class="tt">device-data</span> ledger</li>
<li>✅ Changes sync automatically on next connection</li>
<li>✅ Real-time data continues to flow to Ubidots via webhook</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md18"></a>
Data Reporting</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Counting Mode Payload</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;timestamp&quot;: 1702345678,</div>
<div class="line">    &quot;deviceId&quot;: &quot;e00fce68...&quot;,</div>
<div class="line">    &quot;battery&quot;: 85.2,</div>
<div class="line">    &quot;temp&quot;: 23.5,</div>
<div class="line">    &quot;mode&quot;: &quot;counting&quot;,</div>
<div class="line">    &quot;hourlyCount&quot;: 42,</div>
<div class="line">    &quot;dailyCount&quot;: 327,</div>
<div class="line">    &quot;lastCount&quot;: 1702345670,</div>
<div class="line">    &quot;powerMode&quot;: &quot;connected&quot;,</div>
<div class="line">    &quot;triggerMode&quot;: &quot;interrupt&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
Occupancy Mode Payload</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;timestamp&quot;: 1702345678,</div>
<div class="line">    &quot;deviceId&quot;: &quot;e00fce68...&quot;,</div>
<div class="line">    &quot;battery&quot;: 85.2,</div>
<div class="line">    &quot;temp&quot;: 23.5,</div>
<div class="line">    &quot;mode&quot;: &quot;occupancy&quot;,</div>
<div class="line">    &quot;occupied&quot;: true,</div>
<div class="line">    &quot;sessionDuration&quot;: 120,</div>
<div class="line">    &quot;occupancyStart&quot;: 1702345558,</div>
<div class="line">    &quot;totalOccupiedSec&quot;: 3847,</div>
<div class="line">    &quot;powerMode&quot;: &quot;lowPower&quot;,</div>
<div class="line">    &quot;triggerMode&quot;: &quot;scheduled&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md21"></a>
Getting Started</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md22"></a>
Setup in Particle Console</h2>
<ol type="1">
<li><b>Create Product</b>: "Generalized-Core-Counter-P2"</li>
<li><b>Create Product-Level Ledger</b> (<span class="tt">default-settings</span>):<ul>
<li>Direction: Cloud→Device</li>
<li>Scope: Product</li>
<li>Add JSON configuration (see Configuration Structure above)</li>
<li><b>This is the ONLY ledger you need to manually create</b></li>
</ul>
</li>
<li><b>Device Ledgers</b> (Auto-Created by Firmware):<ul>
<li><span class="tt">device-status</span> (Device→Cloud): Auto-created on first connection, shows current config</li>
<li><span class="tt">device-data</span> (Device→Cloud): Auto-created when device publishes data</li>
<li>These are read-only from Console perspective</li>
</ul>
</li>
<li><b>Device-Settings Ledger</b> (Optional Override):<ul>
<li><b>Create manually in Console</b> if you want device-specific overrides</li>
<li>Direction: Cloud→Device</li>
<li>Scope: Device</li>
<li>Start with JSON from <span class="tt">device-status</span>, then modify as needed</li>
<li>If absent, device uses <span class="tt">default-settings</span></li>
</ul>
</li>
<li><b>Set Up Webhook</b> for Ubidots integration:<ul>
<li>Event name: <span class="tt">sensor-data</span></li>
<li>URL: Your Ubidots endpoint</li>
<li>Request type: POST</li>
<li>JSON template as needed</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
Flash Firmware</h2>
<div class="fragment"><div class="line">particle compile p2 --saveTo firmware.bin</div>
<div class="line">particle flash &lt;device-name&gt; firmware.bin</div>
</div><!-- fragment --><p>Or flash via OTA when device is added to product.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md24"></a>
Monitor Operation</h2>
<div class="fragment"><div class="line">particle serial monitor</div>
</div><!-- fragment --><p>Look for:</p><ul>
<li>"Configuration loaded from cloud"</li>
<li>"Counting mode set to: X"</li>
<li>"Operating mode set to: X"</li>
<li>"Published to webhook: {...}"</li>
<li>"Published data to ledger: {...}"</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md25"></a>
How-To: Common Configuration Tasks</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md26"></a>
Creating Device-Specific Settings</h2>
<p><b>Step 1: View Current Configuration</b></p><ol type="1">
<li>In Particle Console, go to your device</li>
<li>Click "Ledger" tab</li>
<li>Find <span class="tt">device-status</span> ledger (Device→Cloud)</li>
<li>Copy the entire JSON</li>
</ol>
<p><b>Step 2: Create Override</b></p><ol type="1">
<li>In Console, still on device page</li>
<li>Click "Create Ledger"</li>
<li>Name: <span class="tt">device-settings</span></li>
<li>Scope: Device</li>
<li>Direction: Cloud→Device</li>
<li>Paste JSON from <span class="tt">device-status</span></li>
</ol>
<p><b>Step 3: Modify Only What's Different</b> Example - Different park hours: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;timing&quot;: {</div>
<div class="line">        &quot;timezone&quot;: &quot;PST8PDT&quot;,</div>
<div class="line">        &quot;reportingIntervalSec&quot;: 3600,</div>
<div class="line">        &quot;pollingRateSec&quot;: 0,</div>
<div class="line">        &quot;openHour&quot;: 7,          ← Changed from 6</div>
<div class="line">        &quot;closeHour&quot;: 20         ← Changed from 22</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Tip:</b> You only need to include sections with changes. Device merges with defaults.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md27"></a>
Common Customizations</h2>
<p><b>Different Operating Hours:</b> </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;timing&quot;: {</div>
<div class="line">        &quot;openHour&quot;: 8,</div>
<div class="line">        &quot;closeHour&quot;: 18</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Testing Device (Stay Connected, Verbose Logs):</b> </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;messaging&quot;: {</div>
<div class="line">        &quot;serial&quot;: true,</div>
<div class="line">        &quot;verboseMode&quot;: true</div>
<div class="line">    },</div>
<div class="line">    &quot;modes&quot;: {</div>
<div class="line">        &quot;operatingMode&quot;: 0</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Different Sensor Type:</b> </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;sensor&quot;: {</div>
<div class="line">        &quot;threshold1&quot;: 75,</div>
<div class="line">        &quot;threshold2&quot;: 50</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Occupancy Mode Instead of Counting:</b> </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;modes&quot;: {</div>
<div class="line">        &quot;countingMode&quot;: 1,</div>
<div class="line">        &quot;occupancyDebounceMs&quot;: 600000</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md28"></a>
Verifying Configuration Applied</h2>
<ol type="1">
<li>After creating/editing <span class="tt">device-settings</span>, wait for device to connect (or force connection)</li>
<li>Check <span class="tt">device-status</span> ledger - should match your <span class="tt">device-settings</span></li>
<li>Check device logs for "Configuration loaded" messages</li>
<li>If mismatch, check logs for validation errors</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md29"></a>
Extending the Firmware</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md30"></a>
Adding a New Sensor</h2>
<ol type="1">
<li><b>Create sensor class</b> implementing <span class="tt"><a class="el" href="class_i_sensor.html" title="Abstract interface for all sensors.">ISensor</a></span> interface: <div class="fragment"><div class="line"><span class="keyword">class </span>MyNewSensor : <span class="keyword">public</span> <a class="code hl_class" href="class_i_sensor.html">ISensor</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> MyNewSensor* instance();</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_function" href="_generalized-_core-_counter_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>() <span class="keyword">override</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_function" href="_generalized-_core-_counter_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a>() <span class="keyword">override</span>;</div>
<div class="line">    <a class="code hl_struct" href="struct_sensor_data.html">SensorData</a> getSensorData() <span class="keyword">override</span>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* getSensorType() <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="ttc" id="a_generalized-_core-_counter_8cpp_html_a4fc01d736fe50cf5b977f755b675f11d"><div class="ttname"><a href="_generalized-_core-_counter_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a></div><div class="ttdeci">void setup()</div><div class="ttdef"><b>Definition</b> <a href="_generalized-_core-_counter_8cpp_source.html#l00125">Generalized-Core-Counter.cpp:125</a></div></div>
<div class="ttc" id="a_generalized-_core-_counter_8cpp_html_afe461d27b9c48d5921c00d521181f12f"><div class="ttname"><a href="_generalized-_core-_counter_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a></div><div class="ttdeci">void loop()</div><div class="ttdef"><b>Definition</b> <a href="_generalized-_core-_counter_8cpp_source.html#l00346">Generalized-Core-Counter.cpp:346</a></div></div>
<div class="ttc" id="aclass_i_sensor_html"><div class="ttname"><a href="class_i_sensor.html">ISensor</a></div><div class="ttdoc">Abstract interface for all sensors.</div><div class="ttdef"><b>Definition</b> <a href="_i_sensor_8h_source.html#l00075">ISensor.h:75</a></div></div>
<div class="ttc" id="astruct_sensor_data_html"><div class="ttname"><a href="struct_sensor_data.html">SensorData</a></div><div class="ttdoc">Generic sensor data structure.</div><div class="ttdef"><b>Definition</b> <a href="_i_sensor_8h_source.html#l00023">ISensor.h:23</a></div></div>
</div><!-- fragment --></li>
<li><b>Add to <a class="el" href="_sensor_factory_8h.html">SensorFactory.h</a></b>: <div class="fragment"><div class="line"><span class="keywordflow">case</span> MYNEWSENSOR:</div>
<div class="line">    <span class="keywordflow">return</span> MyNewSensor::instance();</div>
</div><!-- fragment --></li>
<li><b>Update <a class="el" href="_config_8h.html" title="Global compile-time configuration options and enums.">Config.h</a></b> with new sensor type enum</li>
<li><b>No changes needed</b> to core state machine or data handling!</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md31"></a>
Memory Constraints</h1>
<ul>
<li>No <span class="tt">String</span> allocations in hot path (loop)</li>
<li>Static buffers for frequently-used data (deviceID)</li>
<li>Stack allocation for JSON (512 bytes acceptable)</li>
<li>Persistent storage auto-managed by StorageHelperRK</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md32"></a>
Offline Data Retention &amp; Firmware Updates</h1>
<ul>
<li><b>Persistent publish queue</b>: All cloud publishes go through PublishQueuePosixRK, which buffers events in RAM and on the <span class="tt">/usr</span> flash filesystem.</li>
<li><b>30+ days of hourly data</b>: The firmware configures a file-backed queue size of 800 events, allowing at least 30 days of hourly reports to be retained during extended network outages before the oldest events are discarded.</li>
<li><b>Guaranteed retry on reconnect</b>: Buffered events are sent on subsequent connections with <span class="tt">WITH_ACK</span> enabled; events are only removed from the queue after successful delivery.</li>
<li><b>Sleep-aware queue handling</b>: The state machine checks that the publish queue is in a sleep-safe state before entering long low-power sleeps, avoiding data loss due to mid-flight publishes.</li>
<li><b>Bounded firmware-update mode</b>: The FIRMWARE_UPDATE state is time-limited (5 minutes by default). If no updates are applied within this window, the device exits update mode and returns toward its normal connect/report/sleep cycle to protect battery life.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md33"></a>
Error Handling &amp; Alert System</h1>
<p>The firmware implements a comprehensive alert system that monitors device health and reports issues through webhooks:</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md34"></a>
Alert Severity Levels</h2>
<p><b>Critical (Tier 3)</b> - Requires immediate attention:</p><ul>
<li><span class="tt">14</span>: Out of memory</li>
<li><span class="tt">15</span>: Modem/disconnect failure</li>
<li><span class="tt">16</span>: Repeated sleep failures (HIBERNATE/ULP)</li>
<li><span class="tt">20</span>: <b>PMIC thermal shutdown</b> (charging stopped due to temperature)</li>
<li><span class="tt">21</span>: <b>PMIC charge timeout</b> (stuck charging - safety timer expired)</li>
</ul>
<p><b>Major (Tier 2)</b> - Should be addressed soon:</p><ul>
<li><span class="tt">22</span>: <b>PMIC input fault</b> (VBUS overvoltage)</li>
<li><span class="tt">23</span>: <b>PMIC battery fault</b> (general charging issue)</li>
<li><span class="tt">30</span>: <a class="el" href="namespace_connectivity.html">Connectivity</a> timeout with radio up</li>
<li><span class="tt">31</span>: Failed to connect to cloud</li>
<li><span class="tt">32</span>: Connect taking too long</li>
<li><span class="tt">40</span>: Repeated webhook failures (&gt;6 hours without response)</li>
<li><span class="tt">41</span>: Configuration/ledger apply failure</li>
<li><span class="tt">42</span>: Data ledger publish failure</li>
<li><span class="tt">43</span>: Publish queue not drained before forced sleep</li>
</ul>
<p><b>Minor (Tier 1)</b> - Informational warnings</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md35"></a>
PMIC Monitoring &amp; Remediation (Boron Only)</h2>
<p>For Boron devices with BQ24195 PMIC, the firmware actively monitors charging health:</p>
<p><b>Detection:</b></p><ul>
<li>Reads PMIC fault registers every battery check cycle</li>
<li>Monitors for thermal shutdown, charge timeout, input faults</li>
<li>Tracks stuck charging states (&gt;6 hours at same SoC)</li>
<li>Logs detailed PMIC status (charge state, VBUS, thermal regulation)</li>
</ul>
<p><b>Smart Remediation with Anti-Thrashing:</b></p><ul>
<li><b>Level 0</b> (Initial): Monitor only, log diagnostics</li>
<li><b>Level 1</b> (2+ consecutive faults): Soft reset - cycle charging off/on</li>
<li><b>Level 2</b> (3+ consecutive faults): Power cycle with watchdog supervision</li>
<li><b>Cooldown</b>: 1 hour minimum between remediation attempts</li>
<li><b>Auto-Clear</b>: Resets counters when charging returns to healthy state</li>
</ul>
<p><b>Escalation Example:</b></p><ol type="1">
<li>First fault detected → Alert raised, monitor only (wait for cooldown)</li>
<li>Second fault after cooldown → Level 1: Cycle charging (disable 500ms, re-enable)</li>
<li>Third fault after cooldown → Level 2: Power cycle with watchdog reset</li>
<li>Charging recovers → Clear alert, reset remediation level</li>
</ol>
<p><b>Benefits:</b></p><ul>
<li>Automatic recovery from common "1Hz amber LED" charging faults</li>
<li>Prevents thrashing (repeated fix attempts)</li>
<li>Detailed diagnostic logs for root cause analysis</li>
<li>Alert webhooks notify monitoring systems before manual intervention needed</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md36"></a>
Error Recovery Strategy</h2>
<ul>
<li>Sensor failures → Connect and report (no reset loops)</li>
<li>Configuration validation with range checking</li>
<li>Graceful degradation for remote deployments</li>
<li>Alerts automatically clear when underlying condition resolves</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md37"></a>
Dependencies</h1>
<ul>
<li>AB1805_RK: RTC and watchdog</li>
<li>LocalTimeRK: Timezone support</li>
<li>PublishQueuePosixRK: Reliable publishing</li>
<li>StorageHelperRK: Persistent storage</li>
<li>BackgroundPublishRK: Non-blocking publishes</li>
<li>SequentialFileRK: File operations</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md38"></a>
Contributing</h1>
<p>When adding features:</p><ol type="1">
<li><b>Maintain simplicity</b>: Keep core logic clean</li>
<li><b>Comment thoroughly</b>: Explain non-obvious decisions</li>
<li><b>Extend, don't modify</b>: Use factory pattern for new types</li>
<li><b>Test remotely</b>: Ensure devices don't brick in field</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md39"></a>
License</h1>
<p>This project is licensed under the MIT License.</p>
<p>You are free to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of this software, subject to the conditions of the MIT License.</p>
<p>See the top-level <span class="tt">LICENSE</span> file in this repository for the complete license text.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md40"></a>
Support</h1>
<p>For issues or questions, contact [Your Contact Info] </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
